cmake_minimum_required(VERSION 3.15)

# DirectShow Virtual Camera DLL Project
project(MySubstituteVirtualCameraDLL)

# Set C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Create the DirectShow Filter DLL
add_library(MySubstituteVirtualCameraDLL SHARED
    src/virtual_camera/virtual_camera_directshow.cpp
    src/virtual_camera/virtual_camera_directshow.h
    src/virtual_camera/directshow_dll_main.cpp
    src/capture/frame.cpp
    src/capture/frame.h
)

# Set output name
set_target_properties(MySubstituteVirtualCameraDLL PROPERTIES
    OUTPUT_NAME "MySubstituteVirtualCamera"
    SUFFIX ".dll"
)

# Include directories
target_include_directories(MySubstituteVirtualCameraDLL PRIVATE
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_CURRENT_SOURCE_DIR}
)

# Link DirectShow libraries
target_link_libraries(MySubstituteVirtualCameraDLL
    strmiids
    quartz
    ole32
    oleaut32
    uuid
    winmm
)

# Add OpenCV if available
find_package(OpenCV QUIET)
if(OpenCV_FOUND)
    target_link_libraries(MySubstituteVirtualCameraDLL ${OpenCV_LIBS})
    target_include_directories(MySubstituteVirtualCameraDLL PRIVATE ${OpenCV_INCLUDE_DIRS})
    target_compile_definitions(MySubstituteVirtualCameraDLL PRIVATE HAVE_OPENCV)
    message(STATUS "DirectShow DLL: OpenCV ${OpenCV_VERSION} found and will be linked")
else()
    message(STATUS "DirectShow DLL: OpenCV not found, building without OpenCV support")
endif()

# Preprocessor definitions for DLL
target_compile_definitions(MySubstituteVirtualCameraDLL PRIVATE
    WIN32_LEAN_AND_MEAN
    _CRT_SECURE_NO_WARNINGS
    MYSUBSTITUTE_DLL_EXPORTS
)

# Module definition file for DLL exports
set(DEF_FILE "${CMAKE_CURRENT_SOURCE_DIR}/src/virtual_camera/MySubstituteVirtualCamera.def")
if(EXISTS ${DEF_FILE})
    set_target_properties(MySubstituteVirtualCameraDLL PROPERTIES
        LINK_FLAGS "/DEF:${DEF_FILE}"
    )
endif()

# Post-build: Copy to main application directory
add_custom_command(TARGET MySubstituteVirtualCameraDLL POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
        $<TARGET_FILE:MySubstituteVirtualCameraDLL>
        ${CMAKE_BINARY_DIR}/bin/$<CONFIG>/MySubstituteVirtualCamera.dll
    COMMENT "Copying DirectShow DLL to application directory"
)